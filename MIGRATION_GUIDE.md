# üîß Stock Batches Migration Guide

## üìå ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà Migration Script ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç

Migration script ‡∏ô‡∏µ‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ 2 ‡∏Å‡∏£‡∏ì‡∏µ‡∏´‡∏•‡∏±‡∏Å:

### 1. **Variant ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ batches ‡πÅ‡∏ï‡πà‡∏°‡∏µ movement records ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏™‡∏ï‡πá‡∏≠‡∏Å**
- **‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏**: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ batch tracking ‡∏´‡∏£‡∏∑‡∏≠ batch ‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
- **‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ**: ‡∏™‡∏£‡πâ‡∏≤‡∏á batch ‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏≤‡∏Å movement ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î

**‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:**
```
SKU: XSR-MOM-PG-N-2XL
- Batches: [] (‡∏ß‡πà‡∏≤‡∏á)
- Movement ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: newStock = 903
‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á batch ‡πÉ‡∏´‡∏°‡πà: quantity = 903
```

### 2. **Variant ‡∏ó‡∏µ‡πà‡∏ú‡∏•‡∏£‡∏ß‡∏° batches ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö movement ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î**
- **‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏**: ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö manual ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó batches
- **‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ**: ‡∏õ‡∏£‡∏±‡∏ö batches ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö movement ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î

**‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:**
```
SKU: ABC-123
- Batches ‡∏£‡∏ß‡∏°: 500 ‡∏ä‡∏¥‡πâ‡∏ô
- Movement ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: newStock = 627
- ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô: +127 ‡∏ä‡∏¥‡πâ‡∏ô
‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á batch ‡πÄ‡∏û‡∏¥‡πà‡∏°: quantity = 127
```

## üöÄ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô

### ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Backend Directory
```bash
cd stock_system/backend
```

### ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô (Dry Run) ‚ö° ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
```bash
node migrate-fix-stock-batches.mjs --dry-run
```

‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏à‡∏∞:
- ‚úÖ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
- ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
- ‚úÖ **‡πÑ‡∏°‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á**
- ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå log ‡πÉ‡∏ô `stock_system/backend/migration-log-{timestamp}.json`

**‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:**
```
=======================================================================
üîß Stock Batches Migration Script
=======================================================================

Mode: üîç DRY RUN (‡πÑ‡∏°‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏£‡∏¥‡∏á)
Database: mongodb://mongo:****@gondola.proxy.rlwy.net:33948/

üì° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ MongoDB...
‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à

üì¶ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...
‚úÖ ‡∏û‡∏ö 150 ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤

üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå variants...
‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à 450 variants
   ‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤: 23 variants

=======================================================================
üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:
=======================================================================

üÜï ‡∏™‡∏£‡πâ‡∏≤‡∏á Batch ‡πÉ‡∏´‡∏°‡πà (15 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£):
   1. ‡∏™‡∏≤‡∏¢‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Ñ‡∏≠ (XSR-MOM-PG-N-2XL)
      ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á batch: 903 ‡∏ä‡∏¥‡πâ‡∏ô
      ‚Üí ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: No batches but movement shows 903 stock
   2. ...

üîß ‡∏õ‡∏£‡∏±‡∏ö Batch (8 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£):
   1. ‡πÄ‡∏ß‡∏•‡∏ö‡∏≠‡∏ó‡∏ô‡πÄ‡∏ö‡∏¢‡πå (XSR-SW-WT-B-S)
      ‚Üí ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: 500 ‚Üí ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: 627 (+127)
      ‚Üí ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: Batch total (500) != Latest movement (627)
   2. ...

=======================================================================
üí° ‡∏ô‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î DRY RUN - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
   ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏£‡∏¥‡∏á ‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á:
   node migrate-fix-stock-batches.mjs
=======================================================================
```

### ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Log File
```bash
# ‡∏î‡∏π log file ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô (‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå stock_system/backend)
cat migration-log-*.json
```

### ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 4: Backup Database (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥) üîí
```bash
# ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Railway/Remote MongoDB
mongodump --uri="mongodb://mongo:KTlBvUhGjEidMDEKLAzevAVCOATaiNsU@gondola.proxy.rlwy.net:33948/" --out=./backup-before-migration

# ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Local MongoDB
mongodump --db=test --out=./backup-before-migration
```

### ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 5: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏£‡∏¥‡∏á (Live Run)
```bash
# ‡∏à‡∏∞‡∏ñ‡∏≤‡∏° confirmation ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
node migrate-fix-stock-batches.mjs

# ‡∏´‡∏£‡∏∑‡∏≠ force ‡πÑ‡∏°‡πà‡∏ñ‡∏≤‡∏°
node migrate-fix-stock-batches.mjs --force
```

**‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:**
```
=======================================================================
üîß Stock Batches Migration Script
=======================================================================

Mode: ‚úèÔ∏è  LIVE RUN (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏£‡∏¥‡∏á)
Database: mongodb://mongo:****@gondola.proxy.rlwy.net:33948/

...

=======================================================================
‚ö†Ô∏è  ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•!
=======================================================================

‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (yes/no): yes

üíæ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç...
‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à 18 ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à 23 variants

üìÑ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log ‡πÑ‡∏õ‡∏ó‡∏µ‡πà: migration-log-1673523456789.json

üëã ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ MongoDB

=======================================================================
‚úÖ Migration ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
=======================================================================
```

## üìä ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°

```bash
# 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ .env ‡∏°‡∏µ MONGODB_URI
cat .env | grep MONGODB_URI

# 2. Dry run ‡∏î‡∏π‡∏Å‡πà‡∏≠‡∏ô
node migrate-fix-stock-batches.mjs --dry-run

# 3. ‡∏î‡∏π log
ls -la migration-log-*.json

# 4. Backup (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥)
mongodump --uri="$MONGODB_URI" --out=./backup-$(date +%Y%m%d)

# 5. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏£‡∏¥‡∏á
node migrate-fix-stock-batches.mjs

# 6. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
node test-stock-consistency.mjs
```

## üîÑ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö (Rollback)

‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å migration:

```bash
# Restore ‡∏à‡∏≤‡∏Å backup
mongorestore --uri="$MONGODB_URI" --drop ./backup-before-migration
```

## ‚öôÔ∏è Options

| Option | ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ |
|--------|----------|
| `--dry-run` | ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏£‡∏¥‡∏á (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠) |
| `--force` | ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ñ‡∏≤‡∏° confirmation |
| (‡πÑ‡∏°‡πà‡∏°‡∏µ option) | ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏£‡∏¥‡∏á ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡∏ñ‡∏≤‡∏° confirmation ‡∏Å‡πà‡∏≠‡∏ô |

## üìã ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà Script ‡∏ó‡∏≥

### 1. ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Database
- ‡∏≠‡πà‡∏≤‡∏ô `MONGODB_URI` ‡∏à‡∏≤‡∏Å `.env` ‡∏ó‡∏µ‡πà root directory
- ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö MongoDB

### 2. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
- ‡∏î‡∏∂‡∏á Products ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
- ‡∏î‡∏∂‡∏á StockMovements ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

### 3. ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏ï‡πà‡∏•‡∏∞ Variant
‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ variant:
- ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏£‡∏ß‡∏° `batch.quantity`
- ‡∏´‡∏≤ movement ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
- ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ß‡πà‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà

### 4. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà dry-run)
- **‡∏Å‡∏£‡∏ì‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å**: ‡∏™‡∏£‡πâ‡∏≤‡∏á batch ‡πÉ‡∏´‡∏°‡πà
- **‡∏Å‡∏£‡∏ì‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å**: Consume ‡∏à‡∏≤‡∏Å batches ‡πÄ‡∏î‡∏¥‡∏° (FIFO)
- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏•‡∏±‡∏ö database

### 5. ‡∏™‡∏£‡πâ‡∏≤‡∏á Log File
- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô JSON
- ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå: `migration-log-{timestamp}.json`

## üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå

### ‡πÉ‡∏ô MongoDB Compass/Shell
```javascript
// ‡∏î‡∏π‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
db.products.find({
  "variants.batches.batchRef": /^MIGRATION/
})

// ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô batch ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å migration
db.products.aggregate([
  { $unwind: "$variants" },
  { $unwind: "$variants.batches" },
  { $match: { "variants.batches.batchRef": /^MIGRATION/ } },
  { $count: "migrationBatches" }
])
```

### ‡∏ú‡πà‡∏≤‡∏ô Test Script
```bash
export AUTH_TOKEN="your-jwt-token"
node test-stock-consistency.mjs
```

### ‡πÉ‡∏ô UI
1. ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ **Products** ‚Üí ‡∏î‡∏π‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
2. ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ **Dashboard** ‚Üí ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
3. ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ **Insights** ‚Üí ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
4. ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ **Movements** ‚Üí ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß

## ‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á

### 1. **Backup ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠!**
Migration script ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Ñ‡∏ß‡∏£ backup ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á

### 2. **‡∏£‡∏±‡∏ô Dry Run ‡∏Å‡πà‡∏≠‡∏ô**
‡∏Ñ‡∏ß‡∏£‡∏£‡∏±‡∏ô `--dry-run` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡πâ‡∏≤‡∏á

### 3. **‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö MONGODB_URI**
‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö database ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà production ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö)

### 4. **Movement Records ‡πÄ‡∏õ‡πá‡∏ô Source of Truth**
Script ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ movement ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å ‡∏´‡∏≤‡∏Å‡∏°‡∏µ variant ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ movement ‡πÄ‡∏•‡∏¢ ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç

### 5. **Production Database**
‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡∏£‡∏±‡∏ô‡∏Å‡∏±‡∏ö production database:
- ‡∏Ñ‡∏ß‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏±‡∏ö staging/test database ‡∏Å‡πà‡∏≠‡∏ô
- ‡∏£‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≠‡∏¢
- ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° rollback plan

## üìù Log File Format

```json
{
  "timestamp": "2026-01-12T10:30:45.123Z",
  "mode": "LIVE_RUN",
  "totalVariants": 450,
  "variantsWithIssues": 23,
  "issues": [
    {
      "productId": "60a1b2c3d4e5f6g7h8i9j0k1",
      "productName": "‡∏™‡∏≤‡∏¢‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Ñ‡∏≠",
      "variantId": "60a1b2c3d4e5f6g7h8i9j0k2",
      "sku": "XSR-MOM-PG-N-2XL",
      "batchCount": 0,
      "batchTotal": 0,
      "latestMovement": {
        "type": "adjust",
        "newStock": 903,
        "date": "2026-01-11T15:20:30.000Z"
      },
      "action": "CREATE_BATCH",
      "targetStock": 903,
      "reason": "No batches but movement shows 903 stock",
      "fixed": true
    }
  ]
}
```

## üéØ ‡∏™‡∏£‡∏∏‡∏õ

Migration script ‡∏ô‡∏µ‡πâ‡∏à‡∏∞:
- ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ batches ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö movement records
- ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á batch ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö variant ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ batches
- ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö batches ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö movement ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
- ‚úÖ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö dry-run ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
- ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á log file ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
- ‚úÖ ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (‡∏ñ‡∏≤‡∏° confirmation ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)

**‡∏Ç‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô dry-run ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠ ‡πÅ‡∏•‡∏∞ backup database ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏£‡∏¥‡∏á!** üöÄ
