# SKU Formula Implementation Guide

## Overview
The stock system now uses a new enterprise-grade SKU naming formula that provides better scalability and human-readability compared to the previous prefix-based system.

## New SKU Formula

### Format
```
{BrandName} - {CategoryName} - {Model} - {Color} - {Size} - {Material}
```

### Examples
- `Nike - Shoe - AirMax90 - Black - 40 - Leather`
- `Samsung - Electronics - Galaxy S24 - Silver - 256GB - Glass`
- `Adidas - Apparel - Ultraboost - White - S - Polyester`

## Key Differences from Old System

### Old System (Deprecated)
- **Format**: `{CategoryPrefix}-{BrandPrefix}-{Model}-{Color}-{Size}-{RunningNumber}`
- **Example**: `SH-NK-AirMax90-Black-40-0001`
- **Issues**:
  - Uses abbreviations (loses brand/category identity)
  - Requires maintaining running number sequences
  - Not human-readable without lookup tables
  - Difficult to find products by brand/category at a glance

### New System (Current)
- **Format**: `{BrandName} - {CategoryName} - {Model} - {Color} - {Size} - {Material}`
- **Example**: `Nike - Shoe - AirMax90 - Black - 40 - Leather`
- **Advantages**:
  - Uses full brand and category names (clear identity)
  - No need for running number management
  - Human-readable and searchable
  - Works better with inventory systems
  - Scales for business growth
  - Consistent with product naming conventions

## Implementation Details

### How SKU Generation Works

1. **User Creates Product**
   - User provides: Brand, Category, and Variant details (Model, Color, Size, Material)
   - User leaves SKU field empty (or enters custom value)

2. **Backend Processing**
   - Backend receives variant data
   - If `variant.sku` is empty, it calls `generateSKUFromVariant()`
   - Function constructs SKU from brand name, category name, and variant attributes
   - Generated SKU is saved to database

3. **User Sees Auto-Generated SKU**
   - Product page displays the generated SKU
   - Format is automatically applied without user intervention

### Backend Implementation (products.js)

```javascript
const generateSKUFromVariant = async (product, variant) => {
  // Fetch brand and category names from database
  const brandDoc = await Brand.findById(product.brand);
  const brandName = brandDoc?.name || 'UNKNOWN';
  
  const categoryDoc = await Category.findById(product.category);
  const categoryName = categoryDoc?.name || 'UNKNOWN';
  
  // Build SKU from components
  const parts = [
    brandName,
    categoryName,
    variant.model,
    variant.attributes?.color || variant.color,
    variant.attributes?.size || variant.size,
    variant.attributes?.material || variant.material,
  ].filter(Boolean); // Remove empty values
  
  // Join with separator and uppercase
  return parts.join(' - ').toUpperCase();
};
```

### Frontend Implementation (Products.jsx)

```javascript
// Variant structure includes all required fields
const emptyVariant = {
  sku: '',      // Will be auto-generated by backend
  model: '',    // NEW: Required for SKU formula
  color: '',    // Color variant
  size: '',     // Size variant
  material: '', // Material variant
  price: 0,
  cost: 0,
  stockOnHand: 0,
};

// When creating product, frontend passes empty SKU
const handleCreate = async (e) => {
  const payload = {
    ...newProduct,
    variants: variants.map((v) => ({
      sku: v.sku, // Can be empty - backend will generate
      model: v.model,
      color: v.color,
      size: v.size,
      material: v.material,
      price: v.price,
      cost: v.cost,
      stockOnHand: v.stockOnHand,
    })),
  };
  // ... send to backend
};
```

## User Workflow

### Creating a Product with New SKU Formula

1. **Product Details**
   - Product Name: "Air Max 90"
   - Category: "Shoe" 
   - Brand: "Nike"
   - Status: "âœ… à¹ƒà¸Šà¹‰à¸‡à¸²à¸™" (Active)
   - Stock Alerts: "ðŸ”” à¹€à¸›à¸´à¸”" (Enabled)

2. **Variant Details**
   - Variant 1:
     - **Model**: AirMax90 (NEW - required)
     - Color: Black
     - Size: 40
     - Material: Leather
     - Price: 3,000 THB
     - Stock: 10
   
   - Variant 2:
     - **Model**: AirMax90 (NEW - required)
     - Color: White
     - Size: 41
     - Material: Fabric
     - Price: 2,500 THB
     - Stock: 15

3. **Auto-Generated SKUs**
   - Variant 1 SKU: `NIKE - SHOE - AIRMAX90 - BLACK - 40 - LEATHER`
   - Variant 2 SKU: `NIKE - SHOE - AIRMAX90 - WHITE - 41 - FABRIC`

### CSV Import with New Formula

CSV file format should include model information:

```csv
Product Name,Variant Codes
New Product,Model-1/Black/40/Leather
,Model-1/White/41/Fabric
,Model-2/Red/M/Cotton

à¸„à¸‡à¹€à¸«à¸¥à¸·à¸­,100,200,150
```

The system will:
1. Parse variant codes
2. Extract color, size, material (same as before)
3. Allow manual entry of model field in UI
4. Generate SKU when saving

## Database Schema

### Product Model (Product.js)

```javascript
// Variant schema includes model field
const variantSchema = new mongoose.Schema({
  sku: { type: String, required: true },
  model: String,        // NEW: Product model/variant line
  color: String,        // Variant attribute
  size: String,         // Variant attribute  
  material: String,     // Variant attribute
  price: { type: Number, default: 0 },
  cost: { type: Number, default: 0 },
  stockOnHand: { type: Number, default: 0 },
  incoming: { type: Number, default: 0 },
  reorderPoint: { type: Number, default: 0 },
  allowBackorder: { type: Boolean, default: false },
  batches: [batchSchema],
  status: { type: String, enum: ['active', 'inactive'], default: 'active' },
});
```

## Migration from Old System

### For Existing Products

**Option 1: Manual Update (Recommended)**
1. Edit each product
2. Add Model field to variants
3. Save - SKU will be regenerated
4. Verify new SKU format is correct

**Option 2: Batch Script (Advanced)**
```javascript
// Run this script to update all products
const products = await Product.find();
for (const product of products) {
  for (const variant of product.variants) {
    // Extract model from old SKU or set manually
    // SKU will be regenerated on save
  }
  await product.save();
}
```

## Troubleshooting

### SKU Not Generating
- **Check**: Brand and Category are selected
- **Check**: Model field is filled in variant
- **Check**: Backend is running and database connection is active
- **Solution**: Refresh page, verify inputs, try again

### Model Field Not Visible
- **Check**: Product.jsx is updated with model field UI
- **Check**: Frontend has been reloaded after code changes
- **Solution**: Clear browser cache, hard refresh (Cmd+Shift+R)

### SKU Contains "UNKNOWN"
- **Cause**: Brand or Category lookup failed
- **Check**: Category and Brand IDs are correct in Product document
- **Solution**: 
  1. Verify category/brand exist in database
  2. Check product.category and product.brand fields
  3. Regenerate SKU by saving product again

## Testing the Implementation

### Manual Testing
1. Login to stock system
2. Go to Products page
3. Create new product:
   - Fill name, category, brand
   - Add variants with Model, Color, Size, Material
   - Leave SKU field empty
   - Click Save
4. Verify generated SKU matches expected format

### Automated Testing
```bash
# Set authentication token
export AUTH_TOKEN="your-jwt-token"

# Run test script
node test-sku-formula.mjs
```

Expected output:
```
âœ… Product created successfully!
ðŸ“Š Generated SKUs:
  Variant 1: NIKE - SHOE - AIRMAX90 - BLACK - 40 - LEATHER
  Variant 2: NIKE - SHOE - AIRMAX90 - WHITE - 41 - FABRIC
âœ… All SKUs follow the new formula format!
```

## API Endpoints

### Create Product with New Formula
```http
POST /api/products
Content-Type: application/json
Authorization: Bearer <token>

{
  "name": "Air Max 90",
  "category": "shoe_category_id",
  "brand": "nike_brand_id",
  "status": "active",
  "enableStockAlerts": true,
  "variants": [
    {
      "sku": "",  // Leave empty - will be auto-generated
      "model": "AirMax90",
      "color": "Black",
      "size": "40",
      "material": "Leather",
      "price": 3000,
      "cost": 1500,
      "stockOnHand": 10
    }
  ]
}
```

### Response
```json
{
  "_id": "...",
  "name": "Air Max 90",
  "category": "...",
  "brand": "...",
  "status": "active",
  "variants": [
    {
      "_id": "...",
      "sku": "NIKE - SHOE - AIRMAX90 - BLACK - 40 - LEATHER",
      "model": "AirMax90",
      "color": "Black",
      "size": "40",
      "material": "Leather",
      "price": 3000,
      "cost": 1500,
      "stockOnHand": 10
    }
  ]
}
```

## Benefits of New System

1. **Human-Readable**: Anyone can understand what product a SKU refers to
2. **Searchable**: Can search by brand name within SKU
3. **Scalable**: Handles unlimited products without running number management
4. **Consistent**: Same format for all products
5. **Audit Trail**: SKU directly reflects product specifications
6. **Integration**: Works better with barcode/QR systems and reports
7. **No Conflicts**: No collision risk from running number resets

## Future Enhancements

1. **SKU Customization**: Allow users to customize SKU format per category
2. **SKU History**: Track when/why SKU changed for compliance
3. **Barcode Generation**: Auto-generate barcodes from SKU
4. **SKU Validation**: Prevent duplicate SKUs across system
5. **Format Templates**: Different format per brand (optional)

