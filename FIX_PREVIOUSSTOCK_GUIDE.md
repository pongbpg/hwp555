# üîß ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç previousStock ‡πÉ‡∏ô Stock Movements Database

## ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
Stock movements ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å `previousStock` ‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°‡πÄ‡∏≠‡∏≤ `incoming` (‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö) ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

### ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
```
Movement:
- previousStock: 459 ‚ùå (‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô 409)
- newStock: 452
- quantity: -7

‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πâ‡∏à‡∏£‡∏¥‡∏á:
- stockOnHand: 409
- incoming: 50
- 459 = 409 + 50 (‡∏£‡∏ß‡∏° incoming ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤!)
```

## ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏
‡πÄ‡∏î‡∏¥‡∏° code ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å `previousStock` ‡∏ï‡∏≠‡∏ô Phase 1 (‡∏Å‡πà‡∏≠‡∏ô applyStockChange) ‡∏ã‡∏∂‡πà‡∏á‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å variant object ‡∏ó‡∏µ‡πà‡∏°‡∏µ `incoming` ‡∏≠‡∏¢‡∏π‡πà

## ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç

### 1Ô∏è‚É£ ‡πÉ‡∏ä‡πâ Script ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)

#### Option A: Chain-based Fix (‡∏á‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
```bash
cd stock_system/backend
node scripts/fix-previous-stock-chain.mjs
```

**‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô**:
- ‡∏î‡∏∂‡∏á movements ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
- ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ variant:
  - Movement ‡∏ó‡∏µ‡πà 1 ‡πÑ‡∏°‡πà‡πÅ‡∏Å‡πâ (‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)
  - Movement ‡∏ó‡∏µ‡πà 2 ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô: `previousStock = newStock ‡∏Ç‡∏≠‡∏á movement ‡∏ó‡∏µ‡πà 1`
  - ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì `newStock = previousStock + quantity`

‚úÖ **‡∏Ç‡πâ‡∏≠‡∏î‡∏µ**:
- ‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
- ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à incoming logic
- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á (chain) ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

‚ùå **‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏µ‡∏¢**:
- Movement ‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ variant ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏ú‡∏¥‡∏î (‡πÅ‡∏ï‡πà‡∏°‡∏±‡∏Å‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)

---

#### Option B: Incoming-aware Fix (‡∏î‡∏µ)
```bash
cd stock_system/backend
node scripts/fix-previous-stock-incoming.mjs
```

**‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô**:
- ‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ö Option A
- ‡πÅ‡∏ï‡πà‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ movement ‡∏°‡∏µ orderId ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
- ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ orderId ‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏ß‡πà‡∏≤ incoming ‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏°‡∏µ‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£

‚úÖ **‡∏Ç‡πâ‡∏≠‡∏î‡∏µ**:
- ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô
- ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤ incoming ‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î

‚ùå **‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏µ‡∏¢**:
- ‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô
- ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à order data structure

---

### 2Ô∏è‚É£ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏±‡∏ô

‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô:

```bash
# ‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏°‡∏µ movements ‡∏Å‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
node scripts/check-movement-detail.js

# ‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏π‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
node scripts/debug-double-inventory.mjs
```

---

## ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥

### 1. ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
```bash
# ‡πÉ‡∏ô MongoDB Atlas ‡∏´‡∏£‡∏∑‡∏≠ local MongoDB
mongodump --db stock_system --out ./backup_before_fix
```

### 2. ‡∏£‡∏±‡∏ô Script
```bash
# ‡πÉ‡∏ä‡πâ Option A (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)
cd stock_system/backend
node scripts/fix-previous-stock-chain.mjs
```

### 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
```bash
# ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
node scripts/check-movement-detail.js | head -50
```

### 4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Dashboard
- ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä Frontend
- ‡∏î‡∏π Movements page ‡∏ß‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà

---

## Code Changes (‡πÉ‡∏ô inventory.js)

‡∏ï‡∏£‡∏á‡∏à‡∏∏‡∏î Phase 4 ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å:
```javascript
// ‚ùå ‡πÄ‡∏î‡∏¥‡∏°: ‡πÉ‡∏ä‡πâ previousStock ‡∏à‡∏≤‡∏Å Phase 1 (‡∏≠‡∏≤‡∏à‡∏£‡∏ß‡∏° incoming)
movementRecords.push({
  ...
  previousStock: previousStock,  // ‚úó ‡∏ú‡∏¥‡∏î
  ...
});
```

‡πÄ‡∏õ‡πá‡∏ô:
```javascript
// ‚úÖ ‡πÉ‡∏´‡∏°‡πà: ‡∏î‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô applyStockChange
const stockBeforeChange = variant.stockOnHand || 0;
applyStockChange(...);
const actualNewStock = variant.stockOnHand || 0;

movementRecords.push({
  ...
  previousStock: stockBeforeChange,  // ‚úì ‡∏ñ‡∏π‡∏Å
  newStock: actualNewStock,          // ‚úì ‡∏ñ‡∏π‡∏Å
  ...
});
```

---

## ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ

‚úÖ **‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡∏ñ‡πâ‡∏≤**:
- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å stock movements ‡πÅ‡∏•‡πâ‡∏ß previousStock ‡∏ú‡∏¥‡∏î
- ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• movement ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
- ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏≠‡∏Å databases ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö analytics

‚ùå **‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡∏ñ‡πâ‡∏≤**:
- ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å movements ‡πÄ‡∏•‡∏¢
- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ production data

---

## FAQ

### Q: Script ‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ stock on hand ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
**A**: ‡πÑ‡∏°‡πà script ‡πÅ‡∏Å‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡πà‡∏≤ `previousStock` ‡πÅ‡∏•‡∏∞ `newStock` ‡πÉ‡∏ô movement record ‡∏ä‡∏±‡πâ‡∏ô stock ‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô

### Q: ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç code ‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏±‡∏ô script ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡πà‡∏≤?
**A**: ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á code ‡πÉ‡∏ô inventory.js ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å movement ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß script ‡πÅ‡∏Å‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤

### Q: Script ‡∏£‡∏±‡∏ô‡∏ô‡∏≤‡∏ô‡πÑ‡∏´‡∏°?
**A**: ‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô movements ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 10,000 movements ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 1-2 ‡∏ô‡∏≤‡∏ó‡∏µ

### Q: ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏´‡∏°?
**A**: ‡∏ï‡πà‡∏≥‡∏°‡∏≤‡∏Å script ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• movement ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤

---

## ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç

1. ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Movements page ‡∏ß‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡∏Å‡πà‡∏≠‡∏ô/‡∏´‡∏•‡∏±‡∏á ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
2. ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Insights API ‡∏ß‡πà‡∏≤ data ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
3. ‚úÖ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Sales order ‡πÅ‡∏•‡∏∞ Purchase order ‡πÉ‡∏´‡∏°‡πà
4. ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Dashboard summary values

---

## ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á

- [MOVEMENTS_CANCELLED_FIX.md](../MOVEMENTS_CANCELLED_FIX.md) - ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ movements ‡∏à‡∏≤‡∏Å cancelled orders
- [STOCK_ALERT_FIX.md](../STOCK_ALERT_FIX.md) - ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ stock alert calculations
- [inventory.js](./routes/inventory.js) - Order processing logic
